# meta developer: @user6268
# scope: hikka_only

from .. import loader, utils
from gtts import gTTS
import subprocess
import os
import asyncio

@loader.tds
class TextToVoiceMod(loader.Module):
    """Озвучивает текст как голосовое сообщение"""
    strings = {"name": "TextToVoice"}

    async def vtextcmd(self, message):
        """<текст> — озвучивает текст"""
        text = utils.get_args_raw(message)
        if not text:
            await message.edit("❌ Укажи текст: `.vtext Пример текста`")
            return

        await self._speak_text(text, message)

    async def rtextcmd(self, message):
        """Озвучивает сообщение по реплаю"""
        reply = await message.get_reply_message()
        if not reply or not reply.text:
            await message.edit("❌ Ответь на текстовое сообщение")
            return

        await self._speak_text(reply.text, message)

    async def _speak_text(self, text, message):
        mp3_path = "/tmp/voice.mp3"
        ogg_path = "/tmp/voice.ogg"

        try:
            # Создаем mp3 из текста
            tts = gTTS(text, lang="ru")
            tts.save(mp3_path)

            # Преобразуем в .ogg (Opus) голосовое сообщение
            convert = await asyncio.create_subprocess_exec(
                "ffmpeg", "-i", mp3_path,
                "-c:a", "libopus",
                "-b:a", "64k",
                "-vbr", "on",
                "-compression_level", "10",
                ogg_path,
                stdout=subprocess.DEVNULL,
                stderr=subprocess.PIPE
            )
            _, err = await convert.communicate()

            if not os.path.exists(ogg_path):
                await message.edit(f"❌ Ошибка при конвертации:\n{err.decode()}")
                return

            await message.client.send_file(
                message.chat_id,
                ogg_path,
                voice_note=True,
                reply_to=message.reply_to_msg_id
            )
            await message.delete()

        except Exception as e:
            await message.edit(f"❌ Ошибка: {e}")

        finally:
            for path in [mp3_path, ogg_path]:
                if os.path.exists(path):
                    os.remove(path)
