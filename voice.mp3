
# meta developer: @user6268
# scope: hikka / heroku

from .. import loader, utils
from gtts import gTTS
import os

@loader.tds
class TextToAudioMod(loader.Module):
    """Озвучивает текст как аудио (без ffmpeg, быстро)"""
    strings = {"name": "SayAudio"}

    async def saycmd(self, message):
        """<текст> — озвучить текст"""
        text = utils.get_args_raw(message)
        if not text:
            return await message.edit("❌ Укажи текст: `.say Привет, как дела?`")
        await self._speak(text, message)

    async def rsaycmd(self, message):
        """Озвучить сообщение по реплаю"""
        reply = await message.get_reply_message()
        if not reply or not reply.text:
            return await message.edit("❌ Ответь на текстовое сообщение")
        await self._speak(reply.text, message)

    async def _speak(self, text, message):
        path = "/tmp/voice.mp3"
        try:
            tts = gTTS(text, lang="ru")
            tts.save(path)

            await message.client.send_file(
                message.chat_id,
                path,
                voice_note=False,
                reply_to=message.reply_to_msg_id
            )
        except Exception as e:
            return await message.edit(f"❌ Ошибка: {e}")
        finally:
            await message.delete()
            if os.path.exists(path):
                os.remove(path)
